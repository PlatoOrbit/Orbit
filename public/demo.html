<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Orbit</title>
  <meta content="width=device-width, initial-scale=1.0" name="viewport">
  <meta content="" name="keywords">
  <meta content="" name="description">


  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
  <!-- Favicons -->
  <link href="img/favicon.png" rel="icon">
  <link href="img/apple-touch-icon.png" rel="apple-touch-icon">

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,300i,400,400i,700,700i|Poppins:300,400,500,700" rel="stylesheet">

  <!-- Bootstrap CSS File -->
  <link href="lib/bootstrap/css/bootstrap.min.css" rel="stylesheet">

  <!-- Font Awesome -->
  <script src="https://kit.fontawesome.com/378fada152.js" crossorigin="anonymous"></script>

  <!-- Main Stylesheet File -->
  <link href="css/basic.css" rel="stylesheet">


  <style>
    body{
      width: 100%;
    }

  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-light bg-light fixed-top" id="feed-nav">
  <a class="navbar-brand" href="/test">Orbit</a>
  <a class="nav-link dropdown-toggle" href="#" id="viewsDropdown" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Views</a>
  <div class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink" id="views-dropdown">
    <a class="dropdown-item" href="#">Action</a>
  </div>
  <button class="btn btn-light" id="refresh" onclick="refreshFeed()"><i class="fas fa-sync" id="refresh-spinner" ></i> Refresh</button>
  <button class="btn btn-light" type="button" id="settings" data-toggle="modal" data-target="#settingsModal"><i class="fas fa-sliders-h"></i> Settings</button>
  <button class="btn btn-light" type="button" id="sources" data-toggle="modal" data-target="#sourcesModal"><i class="fas fa-inbox"></i> Sources</button>
  <button class="btn btn-light" type="button" id="rules" data-toggle="modal" data-target="#rulesModal"><i class="fas fa-code"></i> Rules</button>


</nav>

    <div id="preview" class="sidenav">
      <p class="vertical-center">This is the preview area. If a provider allows you to embed resources, you will see it here. Otherwise, we will just open another page. </p>
       <iframe name="iFramePreview" id="iFramePreview"></iframe>

    </div>
  <div id="feed" class="main">



  <!--Settings Modal-->
  <div class="modal fade" id="settingsModal" tabindex="-1" role="dialog" aria-labelledby="settingsModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLabel">Settings</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body" >
          <form id="settings-body"></form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary">Save changes</button>
        </div>
      </div>
    </div>
  </div>


  <!-- Sources Modal -->
  <div class="modal fade" id="sourcesModal" tabindex="-1" role="dialog" aria-labelledby="sourcesModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="sourcesModalLabel">Sources Modal</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body" >
          <form id="sources-body"></form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary">Save changes</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Rules Modal -->
  <div class="modal fade" id="rulesModal" tabindex="-1" role="dialog" aria-labelledby="rulesModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="rulesModalLabel">Rules Modal</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <form id="rules-body"></form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary">Save changes</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js" integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>


  <script>
    var queue = [{"type":"maps","text":"New Restaurant Opened","link":"https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d3967.850574897747!2d-83.01001721592384!3d40.00625070081755!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x88388ea3555d5397%3A0x1f83030bafcb1f6a!2sBuffalo%20Wild%20Wings!5e0!3m2!1sen!2sus!4v1574718338497!5m2!1sen!2sus"},{"type":"story","title":"Star Fox 2, Super Punch-Out!! coming to Nintendo Switch Online in December","URL":"https://www.polygon.com/2019/12/4/20996289/nintendo-switch-online-snes-nes-games-december-star-fox-2-super-punch-out"},{"type":"story","title":"The new Star Wars dark ride Rise of the Resistance delivers sensory overload","URL":"https://www.polygon.com/star-wars/2019/12/4/20996002/rise-of-the-resistance-opening-review-pov-galaxys-edge-star-wars-land-disney-world"},{"type":"story","title":"Tom Clancy’s The Division 2 gets a permadeath mode next week and ... snowballs?","URL":"https://www.polygon.com/2019/12/4/20996168/tom-clancys-the-division-2-permadeath-mode-pc-ps4-xbox-one-update-ubisoft"},{"type":"story","title":"Disney’s Star Wars land hotel opens in 2021, here’s how it works","URL":"https://www.polygon.com/2019/12/4/20995951/star-wars-land-hotel-opening-day-2021-price-per-night"},{"type":"story","title":"Pokémon Go is getting an evolution-themed event, featuring Shiny Burmy","URL":"https://www.polygon.com/pokemon-go/2019/12/4/20995945/pokemon-go-evolution-event-dates-time-shiny-burmy"},{"type":"story","title":"Vikings: Season 6 Premiere Review","URL":"http://feeds.ign.com/~r/ign/all/~3/7iQOdlqo_Ko/vikings-season-6-premiere-new-beginnings-the-prophet-review-recap-bjorn-ivar-lagertha"},{"type":"story","title":"What Did You Think of Tonight's South Park?","URL":"http://feeds.ign.com/~r/ign/all/~3/DvgUZju_ilM/south-park-season-23-episode-8-basic-cable-review"},{"type":"story","title":"The Best Cyber Monday 2019 Dell Deals (Updated)","URL":"http://feeds.ign.com/~r/ign/all/~3/irx17eYJo5M/best-black-friday-2019-dell-deals-alienware-gaming-laptops-desktop-pcs-monitors-vizio-lg-oled-tvs-ps4-slim-ps4-pro-xbox"},{"type":"story","title":"December's Nintendo Switch Online NES and SNES Games Announced","URL":"http://feeds.ign.com/~r/ign/all/~3/TpRqoxaBd-Q/decembers-nintendo-switch-online-nes-and-snes-games-announced-kirby-super-star-star-fox-2-super-punch-out"},{"type":"story","title":"Batman #84 Review","URL":"http://feeds.ign.com/~r/ign/all/~3/W5dZRtROcg4/batman-84-review"}];
    //Iframe Loader Code

    var myFunction = function() {
        var iframeLink = this.getAttribute("data-iframeLink");
        var normalLink = this.getAttribute("data-normalLink");
        if(iframeLink){
          var myIframe = document.getElementsByName('iFramePreview')[0];
          myIframe.style.visibility = 'visible';
          myIframe.src = iframeLink;
        }
        else if(normalLink){
          window.open(normalLink, '_blank');
        }
    };

    function generateModalForm(id,obj,field){
      let formLine = document.createElement("div");
      formLine.classList.add("form-group");

      let label = document.createElement("label");
      label.innerText=field;
      formLine.append(label);

      let input = document.createElement('input');
      input.setAttribute("placeholder",obj[field]);
      input.setAttribute("disabled","disabled");
      formLine.append(input);

      document.getElementById(id).append(formLine);
    }


    //Loading User Data
    const Http = new XMLHttpRequest();
    const url='/debug/loadUser';
    Http.open("GET", url);
    var responseRecieved = false;
    Http.onreadystatechange = (e) => {
      if(responseRecieved || Http.responseText.length === 0){
        return;
      }
      else{
        responseRecieved = true;
      }
      user = JSON.parse(Http.responseText);
      console.log(user);
      //Populate Settings modal
      let settings = user.settings;
      generateModalForm("settings-body", settings, "age");
      //Populate Rules Modal


      //Populate Sources Modal
      let sourcesBody = document.getElementById("sources-body");
      let sources = user.sources;
      sources.forEach(source => {
        //Insert into Modal
        generateModalForm("sources-body",source,"name");
        //Ingest Source
        // addSource(source);
      });

      //Populate Views Dropdown and Rules Modal
      let dropDownBody = document.getElementById("views-dropdown");
      let rulesBody = document.getElementById("rules-body");
      dropDownBody.innerText="";
      rulesBody.innerText="";
      let views = user.views;
      views.forEach(view => {
        let link = document.createElement("a");
        link.setAttribute('href',"#");
        link.classList.add("dropdown-item");
        link.innerText = view.name;
        link.setAttribute('onclick','updateOrder()');
        dropDownBody.append(link);

        let formHeader = document.createElement("h4");
        formHeader.innerText = "View: " + view.name;
        view.rules.forEach(rule => {
          generateModalForm("rules-body",rule,"type");
          generateModalForm("rules-body", rule, "rule");
        });
        rulesBody.append(document.createElement("hr"));
      });

    }
    Http.send();



    function refreshFeed(){
      console.log("Refreshing Feed");
      document.getElementById("refresh-spinner").classList.add("fa-spin");
      document.getElementById("refresh").setAttribute('disabled','disabled');
      displayFeed();
      setTimeout(function(){
        document.getElementById("refresh-spinner").classList.remove("fa-spin");
        document.getElementById("refresh").removeAttribute('disabled');
      },2000);
    }
    function addSourceRSS(url){

      let urlGetter = new XMLHttpRequest();
      let params = JSON.stringify({"url":url});
      urlGetter.open("POST","/debug/parseRSS",true);
      urlGetter.setRequestHeader("Content-type", "JSON")
      urlGetter.onreadystatechange = function(){
        console.log("Recieved Change");
      }
      urlGetter.send(params);

      // parser.parseURL(url, function(err,feed){
      //   for(let i=0;i<5;i++){
      //     let current_item = feed.items[i];
      //     addElem({"title":current_item.title, "URL": current_item.link});
      //   }
      // });
    }
    function addSource(source){
      let type = source.type;
      if(type==="rss-public"){
        //Load first 5 articles
        // let urlGetter = new XMLHttpRequest();
        // let params = JSON.stringify({"publicID":source.publicID});
        // urlGetter.open("POST","/debug/getPublicFeedURL",true);
        // urlGetter.setRequestHeader("Content-type", "applications")
        // urlGetter.setRequestHeader("Content-length", params.length);
        // urlGetter.setRequestHeader("Connection","close");
        //
        // urlGetter.onreadystatechange = function(){
        //   addSourceRSS(queue,urlGetter.responseText);
        // }
        // urlGetter.send(params);
      }
      else if(type === "rss-custom"){
        //Load first 5 articles
        addSourceRSS(source.url);
      }
    }


    function generateHuerstic(){
        return;
    }
    function sortFeed(){
      return;
    }
    function addElem(elem){
      queue.append(elem);
      displayElem(elem);
    }
    function displayElem(elem){
      let feedDiv = document.getElementById("feed");
      //Create new Feed Block
      let newBlock = document.createElement("div");
      newBlock.classList.add("feed-item");
      //Create block based on type
      let type = elem.type;
      let text = document.createElement("p");
      newBlock.append(text);
      if(type === "maps"){
        text.innerText = "Maps: " + elem.text;
        newBlock.setAttribute("data-iframeLink",elem.link);
      }
      else if(type==="story"){
        text.innerText = "News: " + elem.title;
        newBlock.setAttribute("data-normalLink",elem.URL);
      }
      //Add Elem to feed
      feedDiv.append(newBlock);
      newBlock.addEventListener('click', myFunction, false);
    }
    function displayFeed(){
      //Clear Feed
      document.getElementById("feed").innerHTML = "";
      //Reprint Feed
      let delay = 5;
      queue.forEach(elem =>{
        setTimeout(function(){displayElem(elem)},delay);
        delay= delay + (Math.random() * 200);
      });
    }
    function updateOrder(){
      queue.sort(()=>Math.random() - 0.5);
      displayFeed();
    }

    // refreshFeed();
    // displayFeed();
  </script>

</body>
